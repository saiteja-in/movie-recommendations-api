name: Deploy to DigitalOcean Kubernetes

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 600

      - name: Build and push Docker image
        env:
          REGISTRY_NAME: movierec
        run: |
          docker build -t registry.digitalocean.com/${REGISTRY_NAME}/node-app:${GITHUB_SHA::8} .
          docker push registry.digitalocean.com/${REGISTRY_NAME}/node-app:${GITHUB_SHA::8}

      - name: Save DigitalOcean kubeconfig
        run: doctl kubernetes cluster kubeconfig save k8s-1-33-1-do-5-blr1-1763101949513

      - name: Delete existing resources
        run: |
          kubectl delete deployment node-app --ignore-not-found
          kubectl delete service node-app-service --ignore-not-found
          kubectl delete ingress node-app-ingress --ignore-not-found
          kubectl delete secret app-secrets --ignore-not-found
          kubectl delete secret registry-digitaloceanregistry --ignore-not-found
        continue-on-error: true

      - name: Create image pull secret
        env:
          DO_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
        run: |
          kubectl create secret docker-registry registry-digitaloceanregistry \
            --docker-server=registry.digitalocean.com \
            --docker-username=$DO_TOKEN \
            --docker-password=$DO_TOKEN \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Update deployment file
        env:
          REGISTRY_NAME: movierec
        run: |
          sed -i 's|image: registry.digitalocean.com/movierec/node-app:.*|image: registry.digitalocean.com/movierec/node-app:'"${GITHUB_SHA::8}"'|' k8s/deployment.yaml

      - name: Check if cert-manager is installed
        id: check_cert_manager
        run: |
          if kubectl get namespace cert-manager 2>/dev/null; then
            echo "installed=true" >> $GITHUB_OUTPUT
          else
            echo "installed=false" >> $GITHUB_OUTPUT
          fi

      - name: Install cert-manager
        if: steps.check_cert_manager.outputs.installed == 'false'
        run: |
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml
          echo "Waiting for cert-manager to be ready..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance=cert-manager -n cert-manager --timeout=300s || true

      - name: Wait for cert-manager CRDs
        if: steps.check_cert_manager.outputs.installed == 'false'
        run: |
          echo "Waiting for ClusterIssuer CRD to be available..."
          for i in {1..30}; do
            if kubectl get crd clusterissuers.cert-manager.io 2>/dev/null; then
              echo "ClusterIssuer CRD is available"
              break
            fi
            echo "Waiting for ClusterIssuer CRD... ($i/30)"
            sleep 10
          done

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/ingress.yaml

      - name: Apply ClusterIssuer (cert-manager)
        run: |
          kubectl apply -f k8s/cluster-issuer.yaml || echo "Warning: ClusterIssuer may already exist or cert-manager is not fully ready"

      - name: Create and apply Kubernetes secrets
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          TMDB_BASE_URL: ${{ secrets.TMDB_BASE_URL }}
          TMDB_IMAGE_BASE_URL: ${{ secrets.TMDB_IMAGE_BASE_URL }}
        run: |
          cat <<EOF > k8s/app-secrets-filled.yaml
          apiVersion: v1
          kind: Secret
          metadata:
            name: app-secrets
          type: Opaque
          data:
            DATABASE_URL: $(echo -n "$DATABASE_URL" | base64 -w 0)
            JWT_SECRET: $(echo -n "$JWT_SECRET" | base64 -w 0)
            OPENAI_API_KEY: $(echo -n "$OPENAI_API_KEY" | base64 -w 0)
            TMDB_API_KEY: $(echo -n "$TMDB_API_KEY" | base64 -w 0)
            TMDB_BASE_URL: $(echo -n "$TMDB_BASE_URL" | base64 -w 0)
            TMDB_IMAGE_BASE_URL: $(echo -n "$TMDB_IMAGE_BASE_URL" | base64 -w 0)
          EOF
          kubectl apply -f k8s/app-secrets-filled.yaml
          rm k8s/app-secrets-filled.yaml  # Clean up the filled secret file

      - name: Check deployment status
        run: |
          kubectl rollout status deployment/node-app
          kubectl get pods
          kubectl get services
          kubectl get ingress

      - name: Wait for LoadBalancer external IP
        run: |
          echo "Waiting for LoadBalancer external IP..."
          while [ -z $(kubectl get service node-app-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}') ]; do
            sleep 10
          done
          echo "External IP: $(kubectl get service node-app-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')"

      - name: Check ingress status
        run: |
          echo "Ingress status:"
          kubectl describe ingress node-app-ingress

      - name: Check pod logs
        run: |
          echo "Pod logs:"
          kubectl logs -l app=node-app --tail=100

      - name: Deployment summary
        run: |
          echo "Deployment Summary:"
          echo "-------------------"
          echo "Pods:"
          kubectl get pods -l app=node-app
          echo "\nServices:"
          kubectl get services
          echo "\nIngress:"
          kubectl get ingress
          echo "\nExternal IP:"
          kubectl get service node-app-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}'

      - name: Check pod logs (if failure)
        if: failure()
        run: |
          for pod in $(kubectl get pods -l app=node-app -o jsonpath='{.items[*].metadata.name}'); do
            echo "Logs for $pod:"
            kubectl logs $pod
            echo "-------------------"
          done

      - name: Describe deployment (if failure)
        if: failure()
        run: |
          kubectl describe deployment node-app